name: CI/CD OpenShift

on:
  push:
    branches:
      - main

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------- CHECKOUT REPO ----------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---------- LOGIN DOCKER HUB ----------
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: mauriciotoapanta
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ---------- BUILD & PUSH FRONTEND ----------
      - name: Build & Push Frontend
        run: |
          docker build -t mauriciotoapanta/frontend:latest ./charts/frontend
          docker push mauriciotoapanta/frontend:latest

      # ---------- BUILD & PUSH BACKEND API ----------
      - name: Build & Push Backend API
        run: |
          docker build -t mauriciotoapanta/backend-api:latest ./charts/backend-api
          docker push mauriciotoapanta/backend-api:latest

      # ---------- BUILD & PUSH BACKEND DATA ----------
      - name: Build & Push Backend Data
        run: |
          docker build -t mauriciotoapanta/backend-data:latest ./charts/backend-data
          docker push mauriciotoapanta/backend-data:latest

      # ---------- INSTALL OPENSHIFT CLI ----------
      - name: Install OpenShift CLI
        uses: redhat-actions/oc-installer@v1
        with:
          version: 'latest'

      # ---------- LOGIN TO OPENSHIFT ----------
      - name: Login to OpenShift
        env:
          OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN_LOGIN }}
        run: |
          echo "üîê Iniciando sesi√≥n en OpenShift..."
          oc login $OPENSHIFT_SERVER \
            --token=$OPENSHIFT_TOKEN \
            --insecure-skip-tls-verify=true
          echo "‚úÖ Login exitoso en OpenShift"

      # ---------- SETUP HELM ----------
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.3

      # ---------- DEPLOY WITH HELM ----------
      - name: Deploy with Helm to OpenShift
        env:
          OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}
        run: |
          echo "üöÄ Desplegando release en el namespace: $OPENSHIFT_NAMESPACE"
          cd charts/proyecto-final
          helm upgrade --install proyecto-final . --namespace $OPENSHIFT_NAMESPACE
          echo "‚úÖ Despliegue completado correctamente"