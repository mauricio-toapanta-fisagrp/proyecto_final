name: CI/CD OpenShift

on:
  push:
    branches:
      - main  # Se ejecuta al hacer push a main
  workflow_dispatch: {}  # Permite disparar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1锔 Obtener el c贸digo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2锔 Instalar Helm
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0  # Ajusta seg煤n tu versi贸n

      # 3锔 Instalar OpenShift CLI
      - name: Setup OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xvzf oc.tar.gz
          sudo mv oc /usr/local/bin/
          oc version

      # 4锔 Iniciar sesi贸n en OpenShift
      - name: Login to OpenShift
        env:
          OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN_LOGIN }}
        run: |
          echo " Iniciando sesi贸n en OpenShift..."
          oc login $OPENSHIFT_SERVER --token=$OPENSHIFT_TOKEN --insecure-skip-tls-verify

      # 5锔 Desplegar umbrella chart
      - name: Deploy umbrella chart proyecto-final
        env:
          OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}
        run: |
          echo " Desplegando release en el namespace: $OPENSHIFT_NAMESPACE"
          cd proyecto-final                       # ruta correcta al umbrella chart
          helm dependency update                  # actualiza subcharts
          helm upgrade --install proyecto-final . --namespace $OPENSHIFT_NAMESPACE
