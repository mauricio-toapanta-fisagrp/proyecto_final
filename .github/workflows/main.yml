name: CI/CD OpenShift

on:
  push:
    branches:
      - main  # Se ejecuta al hacer push a main
  workflow_dispatch: {}  # Permite disparar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      REGISTRY: docker.io
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}
      OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
      OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
    steps:
      # 1Ô∏è‚É£ Obtener el c√≥digo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1Ô∏è‚É£ Docker Hub
      # ----------------------------
      # üîê LOGIN DOCKER HUB
      # ----------------------------
      - name: "üîê Iniciar sesi√≥n en Docker Hub"
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u $DOCKERHUB_USER --password-stdin

      # ----------------------------
      # üß± BUILD Y PUSH IM√ÅGENES DEL PROYECTO
      # ----------------------------

      - name: "üêç Construir y subir imagen Backend-Data"
        run: |
          docker build -t $DOCKERHUB_USER/backend-data:latest ./backend-data
          docker push $DOCKERHUB_USER/backend-data:latest

      - name: "üêç Construir y subir imagen Backend-API"
        run: |
          docker build -t $DOCKERHUB_USER/backend-api:latest ./backend-api
          docker push $DOCKERHUB_USER/backend-api:latest

      - name: "üêç Construir y subir imagen Frontend (Flask)"
        run: |
          docker build -t $DOCKERHUB_USER/frontend:latest ./frontend
          docker push $DOCKERHUB_USER/frontend:latest

      # ----------------------------
      # üß± PREPARAR IMAGEN MONGODB PERSONALIZADA
      # ----------------------------
      - name: "üß± Verificar o subir imagen MongoDB personalizada"
        run: |
          IMAGE_NAME="$DOCKERHUB_USER/mongodb:6"
          echo "üîç Verificando existencia de $IMAGE_NAME en Docker Hub..."
          
          # Intentar obtener metadata desde el registro
          if curl --silent -f -lSL "https://hub.docker.com/v2/repositories/$DOCKERHUB_USER/mongodb/tags/6/" > /dev/null 2>&1; then
            echo "‚úÖ Imagen ya existe en Docker Hub. No se reconstruye."
          else
            echo "üì¶ Construyendo y subiendo imagen MongoDB personalizada..."
            docker pull mongo:6
            docker tag mongo:6 $IMAGE_NAME
            docker push $IMAGE_NAME
          fi

      # 2Ô∏è‚É£ Instalar Helm
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.12.0  # Ajusta seg√∫n tu versi√≥n

      # 3Ô∏è‚É£ Instalar OpenShift CLI
      - name: Setup OpenShift CLI
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xvzf oc.tar.gz
          sudo mv oc /usr/local/bin/
          oc version

      # 4Ô∏è‚É£ Iniciar sesi√≥n en OpenShift
      - name: Login to OpenShift
        env:
          OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN_LOGIN }}
        run: |
          echo "üîê Iniciando sesi√≥n en OpenShift..."
          oc login $OPENSHIFT_SERVER --token=$OPENSHIFT_TOKEN --insecure-skip-tls-verify

      # 5Ô∏è‚É£ Desplegar umbrella chart
      - name: Deploy umbrella chart proyecto-final
        env:
          OPENSHIFT_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE }}
        run: |
          echo "üöÄ Desplegando release en el namespace: $OPENSHIFT_NAMESPACE"
          cd proyecto-final                       # ruta correcta al umbrella chart
          helm dependency update                  # actualiza subcharts
          helm upgrade --install proyecto-final . --namespace $OPENSHIFT_NAMESPACE
